<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1920, height=1080, initial-scale=1.0, user-scalable=no">
    <title>KETI íŒêµ í‚¤ì˜¤ìŠ¤í¬</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Noto Sans KR', -apple-system, sans-serif;
            background: #000; color: #fff;
            width: 100vw; height: 100vh; overflow: hidden;
        }

        .container { display: flex; width: 100%; height: 100%; }

        /* === LEFT ZONE (Video + Menu) === */
        .left-zone {
            width: 70%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #333;
        }

        /* Video Area */
        .video-area {
            height: 55%;
            background: #000;
            position: relative;
            border-bottom: 1px solid #333;
        }

        .video-wrapper {
            width: 100%;
            height: 100%;
        }

        .video-wrapper iframe,
        .video-wrapper video {
            width: 100%;
            height: 100%;
            border: none;
        }

        .video-overlay {
            position: absolute;
            bottom: 15px;
            left: 15px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .video-overlay button {
            padding: 8px 16px;
            background: rgba(0,0,0,0.7);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        .video-overlay button:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Menu Area */
        .menu-area {
            height: 45%;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(150deg, #1a1a2e, #16213e);
        }

        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .menu-title {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .menu-date {
            text-align: right;
        }

        .menu-date .date { font-size: 0.9rem; color: rgba(255,255,255,0.6); }
        .menu-date .weekday {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-top: 4px;
        }

        .info-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-card {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.08);
        }

        .info-card.weather { background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(118,75,162,0.2)); }
        .info-card.air { background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(29,78,216,0.2)); }

        .info-emoji { font-size: 1.5rem; }
        .info-label { font-size: 0.75rem; color: rgba(255,255,255,0.5); margin: 5px 0 3px; }
        .info-value { font-size: 1.3rem; font-weight: 700; }
        .info-value small { font-size: 0.7rem; opacity: 0.6; }
        .info-sub { font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-top: 4px; }

        .badge { display: inline-block; padding: 2px 8px; border-radius: 8px; font-size: 0.7rem; }
        .badge.good { background: rgba(74,222,128,0.3); color: #4ade80; }
        .badge.normal { background: rgba(251,191,36,0.3); color: #fbbf24; }
        .badge.bad { background: rgba(251,146,60,0.3); color: #fb923c; }

        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .menu-section { }

        .section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: rgba(255,255,255,0.8);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-card {
            background: rgba(255,255,255,0.05);
            border-radius: 14px;
            padding: 14px;
            border: 1px solid rgba(255,255,255,0.08);
            margin-bottom: 10px;
        }

        .menu-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .menu-emoji { font-size: 1.2rem; }
        .menu-name { font-size: 0.95rem; font-weight: 600; }
        .menu-price { font-size: 0.75rem; color: rgba(255,255,255,0.5); }

        .menu-items { display: flex; flex-wrap: wrap; gap: 6px; }
        .menu-item {
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 10px;
            font-size: 0.85rem;
            color: rgba(255,255,255,0.85);
        }

        .loading { text-align: center; padding: 20px; color: rgba(255,255,255,0.4); font-size: 0.85rem; }
        .error { text-align: center; padding: 15px; background: rgba(239,68,68,0.15); border-radius: 10px; color: rgba(255,255,255,0.7); font-size: 0.85rem; }

        /* === RIGHT ZONE (Scheduler) === */
        .right-zone {
            width: 30%;
            display: flex;
            flex-direction: column;
            background: #141414;
        }

        .sch-header {
            padding: 15px 20px;
            background: #1c1c1e;
            border-bottom: 1px solid #333;
        }

        .sch-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .sch-title { font-size: 1.2rem; font-weight: 700; }
        .sch-clock { font-size: 1.5rem; font-weight: 300; font-variant-numeric: tabular-nums; }

        .sch-sub {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sch-date { font-size: 0.85rem; color: #888; }
        .sch-stats { font-size: 0.8rem; color: #888; }
        .sch-stats b { color: #0A84FF; margin: 0 8px 0 3px; }

        .sch-body {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .loc-grp {
            background: #1a1a1c;
            border: 1px solid #333;
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .loc-h {
            padding: 10px 14px;
            background: rgba(255,255,255,0.04);
            border-bottom: 1px solid #333;
            font-weight: 700;
            font-size: 0.95rem;
            color: #ddd;
            display: flex;
            justify-content: space-between;
        }

        .loc-h span:last-child { cursor: pointer; color: #666; }
        .loc-h span:last-child:hover { color: #fff; }

        .tl-hd {
            display: flex;
            height: 28px;
            background: #222;
            border-bottom: 1px solid #333;
        }

        .tl-nm-col {
            width: 70px;
            border-right: 1px solid #333;
            flex-shrink: 0;
        }

        .tl-tr-col { flex: 1; display: flex; }

        .tm-lbl {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #555;
            border-right: 1px solid rgba(255,255,255,0.04);
        }

        .tl-row {
            display: flex;
            height: 55px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .tl-nm {
            width: 70px;
            border-right: 1px solid #333;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #bbb;
            font-weight: 600;
            background: #1a1a1c;
            text-align: center;
            padding: 0 4px;
            word-break: keep-all;
        }

        .tl-tr {
            flex: 1;
            position: relative;
            background: #121212;
        }

        .g-lines {
            position: absolute;
            inset: 0;
            display: flex;
            pointer-events: none;
        }

        .g-cell {
            flex: 1;
            border-right: 1px solid rgba(255,255,255,0.03);
        }

        .now-bar {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ff453a;
            z-index: 20;
            display: none;
        }

        .bk-bar {
            position: absolute;
            top: 8px;
            bottom: 8px;
            background: #0A84FF;
            border-radius: 4px;
            font-size: 10px;
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            padding: 0 6px;
            overflow: hidden;
            white-space: nowrap;
            cursor: pointer;
            z-index: 10;
            box-shadow: 1px 2px 4px rgba(0,0,0,0.4);
        }

        .bk-bar:hover { background: #3399ff; }

        /* Modal */
        #modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .m-box {
            width: 360px;
            background: #222;
            padding: 25px;
            border-radius: 14px;
            border: 1px solid #444;
        }

        .m-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .m-r {
            display: flex;
            margin-bottom: 12px;
            font-size: 14px;
            color: #ddd;
        }

        .m-l { width: 60px; color: #777; }

        .m-btn {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            background: #0A84FF;
            border: none;
            color: white;
            border-radius: 8px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
        }

        .m-btn:hover { background: #3399ff; }
    </style>
</head>
<body>

<div class="container">
    <!-- LEFT: Video + Menu -->
    <div class="left-zone">
        <!-- Video -->
        <div class="video-area">
            <div class="video-wrapper" id="videoWrapper">
                <iframe id="ytPlayer"
                    src="https://www.youtube.com/embed?listType=user_uploads&list=KIKIETI&autoplay=1&mute=1&loop=1&controls=0&modestbranding=1"
                    allow="autoplay; encrypted-media" allowfullscreen></iframe>
            </div>
            <div class="video-overlay">
                <button onclick="changeVideo(-1)">â—€ ì´ì „</button>
                <button onclick="changeVideo(1)">ë‹¤ìŒ â–¶</button>
                <button onclick="toggleMute()">ğŸ”Š ìŒì†Œê±° í•´ì œ</button>
            </div>
        </div>

        <!-- Menu -->
        <div class="menu-area">
            <div class="menu-header">
                <div class="menu-title">ğŸ½ï¸ ì˜¤ëŠ˜ì˜ ì‹ë‹¨</div>
                <div class="menu-date">
                    <div class="date" id="menuDate">-</div>
                    <span class="weekday" id="menuWeekday">-</span>
                </div>
            </div>

            <div class="info-row">
                <div class="info-card weather" id="weather">
                    <div class="info-emoji">ğŸŒ¡ï¸</div>
                    <div class="info-label">ë‚ ì”¨</div>
                    <div class="info-value">--Â°C</div>
                    <div class="info-sub">ë¡œë”©ì¤‘...</div>
                </div>
                <div class="info-card air" id="air">
                    <div class="info-emoji">ğŸ’¨</div>
                    <div class="info-label">ë¯¸ì„¸ë¨¼ì§€</div>
                    <div class="info-value">--</div>
                    <div class="info-sub">ë¡œë”©ì¤‘...</div>
                </div>
            </div>

            <div class="menu-grid">
                <div class="menu-section" id="pangyo">
                    <div class="section-title">ğŸ¢ íŒêµí…Œí¬ë…¸ë°¸ë¦¬</div>
                    <div class="loading">ë¡œë”©ì¤‘...</div>
                </div>
                <div class="menu-section" id="biopark">
                    <div class="section-title">ğŸ¢ ë°”ì´ì˜¤íŒŒí¬</div>
                    <div class="loading">ë¡œë”©ì¤‘...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- RIGHT: Scheduler -->
    <div class="right-zone">
        <div class="sch-header">
            <div class="sch-top">
                <div class="sch-title">ğŸ“… KETI íšŒì˜ì‹¤</div>
                <div class="sch-clock" id="clock">00:00:00</div>
            </div>
            <div class="sch-sub">
                <div class="sch-date" id="schDate">-</div>
                <div class="sch-stats">GL<b id="sG">0</b>GBC<b id="sB">0</b></div>
            </div>
        </div>
        <div class="sch-body" id="schContent">
            <div class="loading">íšŒì˜ì‹¤ ì •ë³´ ë¡œë”©ì¤‘...</div>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="modal">
    <div class="m-box">
        <div class="m-title">ğŸ“‹ ì˜ˆì•½ ìƒì„¸</div>
        <div class="m-r"><span class="m-l">ì œëª©</span><span id="mT"></span></div>
        <div class="m-r"><span class="m-l">ì‹œê°„</span><span id="mD"></span></div>
        <div class="m-r"><span class="m-l">ì¥ì†Œ</span><span id="mR"></span></div>
        <div class="m-r"><span class="m-l">ë‹´ë‹¹</span><span id="mU"></span></div>
        <button class="m-btn" onclick="document.getElementById('modal').style.display='none'">ë‹«ê¸°</button>
    </div>
</div>

<script>
    // ========== VIDEO (KETI YouTube) ==========
    // KETI ì±„ë„ ì˜ìƒ ID ëª©ë¡ (ìˆ˜ë™ ë˜ëŠ” APIë¡œ ê°€ì ¸ì˜¤ê¸°)
    const KETI_VIDEOS = [
        'xL4Rc3X1XeU',  // ì˜ˆì‹œ - ì‹¤ì œ KETI ì˜ìƒìœ¼ë¡œ êµì²´ í•„ìš”
        'cS3fRsXJg5Y',
        'HQfF5XnzXMo',
    ];
    let videoIdx = 0;
    let isMuted = true;
    const ytPlayer = document.getElementById('ytPlayer');

    function loadVideo() {
        const vid = KETI_VIDEOS[videoIdx];
        ytPlayer.src = `https://www.youtube.com/embed/${vid}?autoplay=1&mute=${isMuted?1:0}&loop=1&playlist=${vid}&controls=0&modestbranding=1&rel=0`;
    }

    function changeVideo(dir) {
        videoIdx = (videoIdx + dir + KETI_VIDEOS.length) % KETI_VIDEOS.length;
        loadVideo();
    }

    function toggleMute() {
        isMuted = !isMuted;
        loadVideo();
    }

    loadVideo();


    // ========== MENU ==========
    const MENU_API = 'https://sekainokita.github.io/bioparkmenu/data';
    const WEEKDAYS = ['ì¼ìš”ì¼','ì›”ìš”ì¼','í™”ìš”ì¼','ìˆ˜ìš”ì¼','ëª©ìš”ì¼','ê¸ˆìš”ì¼','í† ìš”ì¼'];

    function updateMenuDate() {
        const now = new Date();
        document.getElementById('menuDate').textContent = now.toLocaleDateString('ko-KR', {year:'numeric',month:'long',day:'numeric'});
        document.getElementById('menuWeekday').textContent = WEEKDAYS[now.getDay()];
    }

    async function loadWeather() {
        const el = document.getElementById('weather');
        try {
            const r = await fetch(`${MENU_API}/weather.json?t=${Date.now()}`);
            const d = await r.json();
            el.innerHTML = `
                <div class="info-emoji">${d.icon_emoji || 'ğŸŒ¡ï¸'}</div>
                <div class="info-label">${d.location || 'íŒêµ'}</div>
                <div class="info-value">${d.temp}Â°C</div>
                <div class="info-sub">${d.description}${d.humidity ? ` Â· ${d.humidity}%` : ''}</div>
            `;
        } catch(e) { el.querySelector('.info-sub').textContent = 'ì •ë³´ ì—†ìŒ'; }
    }

    async function loadAir() {
        const el = document.getElementById('air');
        try {
            const r = await fetch(`${MENU_API}/air_quality.json?t=${Date.now()}`);
            const d = await r.json();
            const cls = d.pm10_grade === 'ì¢‹ìŒ' ? 'good' : d.pm10_grade === 'ë³´í†µ' ? 'normal' : 'bad';
            el.innerHTML = `
                <div class="info-emoji">${d.pm10_emoji || 'ğŸ’¨'}</div>
                <div class="info-label">ë¯¸ì„¸ë¨¼ì§€</div>
                <div class="info-value">${d.pm10}<small> ã/ã¥</small></div>
                <div class="info-sub"><span class="badge ${cls}">${d.pm10_grade}</span> PM2.5: ${d.pm25}</div>
            `;
        } catch(e) { el.querySelector('.info-sub').textContent = 'ì •ë³´ ì—†ìŒ'; }
    }

    async function loadPangyo() {
        const section = document.getElementById('pangyo');
        const title = section.querySelector('.section-title').outerHTML;
        try {
            const r = await fetch(`${MENU_API}/pangyo_menu.json?t=${Date.now()}`);
            const data = await r.json();
            const day = new Date().getDay();
            let menu = data.menus?.[WEEKDAYS[day]];
            if (!menu && (day === 0 || day === 6)) menu = data.menus?.['ì›”ìš”ì¼'];
            if (!menu) { section.innerHTML = title + `<div class="error">ë©”ë‰´ ì—†ìŒ</div>`; return; }
            const items = Array.isArray(menu) ? menu : [menu];
            section.innerHTML = title + `
                <div class="menu-card">
                    <div class="menu-card-header">
                        <span class="menu-emoji">ğŸš</span>
                        <div><div class="menu-name">ì¤‘ì‹</div></div>
                    </div>
                    <div class="menu-items">${items.map(i=>`<span class="menu-item">${i}</span>`).join('')}</div>
                </div>
            `;
        } catch(e) { section.innerHTML = title + `<div class="error">ë¡œë“œ ì‹¤íŒ¨</div>`; }
    }

    async function loadBiopark() {
        const section = document.getElementById('biopark');
        const title = section.querySelector('.section-title').outerHTML;
        try {
            const r = await fetch(`${MENU_API}/menu.json?t=${Date.now()}`);
            const data = await r.json();
            const day = new Date().getDay();
            let menu = data.menus?.[WEEKDAYS[day]];
            if (!menu && (day === 0 || day === 6)) menu = data.menus?.['ì›”ìš”ì¼'];
            if (!menu) { section.innerHTML = title + `<div class="error">ë©”ë‰´ ì—†ìŒ</div>`; return; }
            let html = title;
            if (menu['ì¼ë°˜ì‹']) {
                const items = Array.isArray(menu['ì¼ë°˜ì‹']) ? menu['ì¼ë°˜ì‹'] : menu['ì¼ë°˜ì‹'].split(',').map(s=>s.trim());
                html += `<div class="menu-card"><div class="menu-card-header"><span class="menu-emoji">ğŸš</span><div><div class="menu-name">ì¼ë°˜ì‹</div><div class="menu-price">6,000ì›</div></div></div><div class="menu-items">${items.map(i=>`<span class="menu-item">${i}</span>`).join('')}</div></div>`;
            }
            if (menu['ì¼í’ˆì‹']) {
                const items = Array.isArray(menu['ì¼í’ˆì‹']) ? menu['ì¼í’ˆì‹'] : menu['ì¼í’ˆì‹'].split(',').map(s=>s.trim());
                html += `<div class="menu-card"><div class="menu-card-header"><span class="menu-emoji">ğŸœ</span><div><div class="menu-name">ì¼í’ˆì‹</div><div class="menu-price">6,000ì›</div></div></div><div class="menu-items">${items.map(i=>`<span class="menu-item">${i}</span>`).join('')}</div></div>`;
            }
            section.innerHTML = html;
        } catch(e) { section.innerHTML = title + `<div class="error">ë¡œë“œ ì‹¤íŒ¨</div>`; }
    }


    // ========== SCHEDULER ==========
    const MY_TOKEN = 's701wolho5si:sQYP0UfqQD-R6C626bOJtQ';
    const CFG = { START: 8, END: 20 };
    const KST = 'Asia/Seoul';

    function getYMD(d) { return new Intl.DateTimeFormat('sv-SE', { timeZone: KST }).format(d); }
    const todayStr = getYMD(new Date());

    function updateClock() {
        document.getElementById('clock').textContent = new Date().toLocaleTimeString('ko-KR', { hour12: false });
    }

    function calcPos() {
        const now = new Date();
        const h = now.getHours() + now.getMinutes()/60;
        return ((h - CFG.START) / (CFG.END - CFG.START)) * 100;
    }

    function updateLine() {
        const lines = document.querySelectorAll('.now-bar');
        const pos = calcPos();
        lines.forEach(l => {
            if(pos >= 0 && pos <= 100) { l.style.display='block'; l.style.left=`${pos}%`; }
            else { l.style.display='none'; }
        });
    }

    async function loadSchedule() {
        document.getElementById('schDate').textContent = `${todayStr} (${new Date().toLocaleDateString('ko-KR',{weekday:'short'})})`;

        try {
            const proxyBase = 'https://corsproxy.io/?' + encodeURIComponent('https://api.dooray.com');
            const headers = { 'Authorization': `dooray-api ${MY_TOKEN}` };

            const cRes = await fetch(`${proxyBase}/reservation/v1/resource-categories?size=20`, { headers });
            const cData = await cRes.json();

            const locs = (cData.result || [])
                .filter(l => l.name && (l.name.includes('ê¸€ë¡œë²ŒR&D') || l.name.includes('GBC')))
                .sort((a,b) => a.name.includes('ê¸€ë¡œë²Œ') ? -1 : 1);

            const container = document.getElementById('schContent');
            container.innerHTML = '';

            let gCount = 0, bCount = 0;
            const now = new Date();

            for (const loc of locs) {
                const rRes = await fetch(`${proxyBase}/reservation/v1/reservable-resources?resourceCategoryId=${loc.id}&size=100`, { headers });
                const rData = await rRes.json();
                const rooms = rData.result || [];

                let resvs = [];
                if (rooms.length > 0) {
                    const ids = rooms.map(x => x.id).join(',');
                    const tMin = `${todayStr}T00:00:00+09:00`;
                    const tMax = `${todayStr}T23:59:59+09:00`;
                    const vRes = await fetch(`${proxyBase}/reservation/v1/resource-reservations?resourceIds=${ids}&timeMin=${tMin}&timeMax=${tMax}&size=500`, { headers });
                    const vData = await vRes.json();
                    resvs = vData.result || [];
                }

                const isG = loc.name.includes('ê¸€ë¡œë²Œ');
                rooms.forEach(r => {
                    const busy = resvs.some(v => v.resource.id === r.id && now >= new Date(v.startedAt) && now <= new Date(v.endedAt));
                    if(!busy) isG ? gCount++ : bCount++;
                });

                renderLoc(container, loc, rooms, resvs);
            }

            document.getElementById('sG').textContent = gCount;
            document.getElementById('sB').textContent = bCount;

        } catch(e) {
            console.error(e);
            document.getElementById('schContent').innerHTML = '<div class="error">íšŒì˜ì‹¤ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨<br><small style="color:#666">í† í° ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ í™•ì¸</small></div>';
        }
    }

    function renderLoc(parent, loc, rooms, resvs) {
        const grp = document.createElement('div');
        grp.className = 'loc-grp';
        const name = loc.name.includes('ê¸€ë¡œë²Œ') ? 'Global R&D Center' : 'GBC Center';

        let h = `<div class="loc-h"><span>${name}</span><span onclick="loadSchedule()">â†»</span></div>`;
        h += `<div class="tl-hd"><div class="tl-nm-col"></div><div class="tl-tr-col">`;
        for(let i=CFG.START; i<CFG.END; i++) h += `<div class="tm-lbl">${i}</div>`;
        h += `</div></div><div>`;

        rooms.sort((a,b) => a.name.localeCompare(b.name)).forEach(r => {
            let rName = r.name.replace(/\d+ì¸µ/,'').replace(/íšŒì˜ì‹¤/,'').replace(/ëŒ€íšŒì˜ì‹¤/,'ëŒ€').replace(/ì†ŒíšŒì˜ì‹¤/,'ì†Œ').replace(/ì¤‘íšŒì˜ì‹¤/,'ì¤‘').trim();

            h += `<div class="tl-row"><div class="tl-nm">${rName}</div><div class="tl-tr"><div class="g-lines">`;
            for(let i=0; i<(CFG.END-CFG.START); i++) h += `<div class="g-cell"></div>`;

            const pos = calcPos();
            h += `<div class="now-bar" style="${(pos>=0&&pos<=100)?`left:${pos}%;display:block`:'display:none'}"></div></div>`;

            resvs.filter(x => x.resource.id === r.id).forEach(v => {
                const s = new Date(v.startedAt), e = new Date(v.endedAt);
                let off = (s.getHours() + s.getMinutes()/60) - CFG.START;
                let dur = (e.getTime() - s.getTime()) / 3600000;
                const tot = CFG.END - CFG.START;
                if(off<0) { dur+=off; off=0; }
                if(off+dur>tot) dur=tot-off;

                if(dur>0 && off<tot) {
                    const l = (off/tot)*100, w = (dur/tot)*100;
                    const safeT = (v.subject||'').replace(/"/g,'&quot;');
                    const safeU = (v.users?.from?.member?.name||'?').replace(/"/g,'&quot;');
                    const timeS = s.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit',hour12:false});
                    const timeE = e.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit',hour12:false});
                    h += `<div class="bk-bar" style="left:${l}%;width:${w}%;" onclick="pop('${safeT}','${timeS}~${timeE}','${r.name}','${safeU}')">${v.subject||'ì˜ˆì•½'}</div>`;
                }
            });
            h += `</div></div>`;
        });
        h += `</div>`;
        grp.innerHTML = h;
        parent.appendChild(grp);
    }

    function pop(t,d,r,u) {
        document.getElementById('mT').textContent=t;
        document.getElementById('mD').textContent=d;
        document.getElementById('mR').textContent=r;
        document.getElementById('mU').textContent=u;
        document.getElementById('modal').style.display='flex';
    }


    // ========== INIT ==========
    updateMenuDate();
    updateClock();
    loadWeather();
    loadAir();
    loadPangyo();
    loadBiopark();
    loadSchedule();

    setInterval(updateClock, 1000);
    setInterval(updateLine, 60000);
    setInterval(() => { loadWeather(); loadAir(); loadPangyo(); loadBiopark(); }, 300000);
    setInterval(loadSchedule, 180000);

    // ìì • ìƒˆë¡œê³ ì¹¨
    setInterval(() => {
        if (getYMD(new Date()) !== todayStr) location.reload();
    }, 60000);
</script>

</body>
</html>
